name: Release AgentBox Image

# NOTE: GitHub Actions runners don't support nested virtualization,
# so images must be built locally. This workflow creates releases
# from locally-built artifacts.
#
# To release a new image:
# 1. Build images locally: cd build && ./build-image.sh arm64 && ./build-image.sh amd64
# 2. Create a release draft on GitHub
# 3. Upload the .qcow2 and .sha256 files from build/output/
# 4. Publish the release
#
# Alternatively, use the manual workflow dispatch with pre-uploaded artifacts.

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Image version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      release_notes:
        description: 'Additional release notes'
        required: false
        default: ''

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: image-v${{ github.event.inputs.version }}
          name: AgentBox Image v${{ github.event.inputs.version }}
          body: |
            ## AgentBox Pre-built Image v${{ github.event.inputs.version }}

            Pre-provisioned Ubuntu 24.04 image with:
            - zsh + Oh My Zsh + Starship
            - Node.js 22, Python 3, Go 1.22
            - neovim, ripgrep, fzf, jq, tmux
            - mise (version manager)
            - claude-code, opencode

            ### Downloads
            - `agentbox-ubuntu-24.04-arm64.qcow2` - For Apple Silicon Macs
            - `agentbox-ubuntu-24.04-amd64.qcow2` - For Intel Macs

            ### Checksums
            See `.sha256` files for verification.

            ### Building Images Locally
            ```bash
            cd build
            ./build-image.sh arm64  # For Apple Silicon
            ./build-image.sh amd64  # For Intel
            ```

            ${{ github.event.inputs.release_notes }}
          draft: true
          prerelease: false
